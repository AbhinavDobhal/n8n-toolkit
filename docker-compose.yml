services:
  # ═══════════════════════════════════════════════════════════════════════════
  # n8n - Workflow Automation Tool
  # ═══════════════════════════════════════════════════════════════════════════
  n8n:
    image: docker.n8n.io/n8nio/n8n:2.0.3
    container_name: n8n
    restart: unless-stopped
    ports:
      - "5678:5678"
    environment:
      - WEBHOOK_URL=${WEBHOOK_URL:-http://host.docker.internal:5678}
      - N8N_DEFAULT_BINARY_DATA_MODE=filesystem
      - N8N_BASIC_AUTH_ACTIVE=${N8N_BASIC_AUTH_ACTIVE:-false}
      - N8N_BASIC_AUTH_USER=${N8N_BASIC_AUTH_USER:-admin}
      - N8N_BASIC_AUTH_PASSWORD=${N8N_BASIC_AUTH_PASSWORD:-password123}
      - N8N_SECURE_COOKIE=false
      # PostgreSQL Database Configuration
      - DB_TYPE=postgresdb
      - DB_POSTGRESDB_HOST=${DB_POSTGRESDB_HOST:-postgres}
      - DB_POSTGRESDB_PORT=${DB_POSTGRESDB_PORT:-5432}
      - DB_POSTGRESDB_DATABASE=${DB_POSTGRESDB_DATABASE:-n8n}
      - DB_POSTGRESDB_USER=${DB_POSTGRESDB_USER:-root}
      - DB_POSTGRESDB_PASSWORD=${DB_POSTGRESDB_PASSWORD:-root}
      - DB_POSTGRESDB_SCHEMA=public
    volumes:
      - n8n-data:/home/node/.n8n
    networks:
      - n8n-toolkit-network
    depends_on:
      postgres:
        condition: service_healthy
      minio:
        condition: service_healthy

  # ═══════════════════════════════════════════════════════════════════════════
  # PostgreSQL Database
  # ═══════════════════════════════════════════════════════════════════════════
  postgres:
    image: postgres:16-alpine
    container_name: postgres
    restart: unless-stopped
    ports:
      - "5432:5432"
    environment:
      - POSTGRES_USER=${DB_POSTGRESDB_USER:-root}
      - POSTGRES_PASSWORD=${DB_POSTGRESDB_PASSWORD:-root}
      - POSTGRES_DB=${DB_POSTGRESDB_DATABASE:-n8n}
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      - n8n-toolkit-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U root"]
      interval: 10s
      timeout: 5s
      retries: 5

  # ═══════════════════════════════════════════════════════════════════════════
  # MinIO - S3-Compatible Object Storage
  # ═══════════════════════════════════════════════════════════════════════════
  minio:
    image: quay.io/minio/minio:RELEASE.2025-04-22T22-12-26Z
    container_name: minio
    restart: unless-stopped
    ports:
      - "9000:9000"   # API
      - "9001:9001"   # Console
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      - MINIO_ROOT_USER=${MINIO_ROOT_USER:-admin}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD:-password123}
    volumes:
      - minio-data:/data
    command: server /data --console-address ":9001"
    networks:
      - n8n-toolkit-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 20s
      retries: 3

  # ═══════════════════════════════════════════════════════════════════════════
  # MinIO Setup - Creates bucket automatically
  # ═══════════════════════════════════════════════════════════════════════════
  minio-setup:
    image: minio/mc
    container_name: minio-setup
    depends_on:
      minio:
        condition: service_healthy
    entrypoint: >
      /bin/sh -c "
      mc alias set myminio http://minio:9000 $${MINIO_ROOT_USER} $${MINIO_ROOT_PASSWORD};
      mc mb myminio/$${S3_BUCKET_NAME} --ignore-existing;
      mc anonymous set download myminio/$${S3_BUCKET_NAME};
      exit 0;
      "
    environment:
      - MINIO_ROOT_USER=${MINIO_ROOT_USER:-admin}
      - MINIO_ROOT_PASSWORD=${MINIO_ROOT_PASSWORD:-password123}
      - S3_BUCKET_NAME=${S3_BUCKET_NAME:-storage}
    networks:
      - n8n-toolkit-network


  # ═══════════════════════════════════════════════════════════════════════════
  # gTTS Service - Text-to-Speech (FastAPI)
  # ═══════════════════════════════════════════════════════════════════════════
  tts-service:
    build:
      context: ./tts-service
    container_name: tts-service
    restart: unless-stopped
    ports:
      - "8880:5000"
    networks:
      - n8n-toolkit-network

  # ═══════════════════════════════════════════════════════════════════════════
  # NCA Toolkit - No-Code Architects Toolkit
  # ═══════════════════════════════════════════════════════════════════════════
  nca-toolkit:
    image: stephengpope/no-code-architects-toolkit:latest
    platform: linux/amd64
    container_name: nca-toolkit
    restart: unless-stopped
    ports:
      - "8181:8080"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      - API_KEY=${NCA_API_KEY:-1150810d0dd0613bdabd8635bf75e6282ddc505202212ed32c1a8c357fa39d1c}
      - S3_ENDPOINT_URL=http://minio:9000
      - S3_ACCESS_KEY=${MINIO_ROOT_USER:-admin}
      - S3_SECRET_KEY=${MINIO_ROOT_PASSWORD:-password123}
      - S3_BUCKET_NAME=${S3_BUCKET_NAME:-storage}
      - S3_REGION=${S3_REGION:-None}
    depends_on:
      minio:
        condition: service_healthy
    networks:
      - n8n-toolkit-network

# ═══════════════════════════════════════════════════════════════════════════
# Networks
# ═══════════════════════════════════════════════════════════════════════════
networks:
  n8n-toolkit-network:
    driver: bridge

# ═══════════════════════════════════════════════════════════════════════════
# Volumes
# ═══════════════════════════════════════════════════════════════════════════
volumes:
  n8n-data:
    driver: local
  postgres-data:
    driver: local
  minio-data:
    driver: local
  tts-data:
    driver: local
